version: "3.9"

services:
  stripper:
    build:
      context: ./services/stripper
      dockerfile: Dockerfile
    image: exif-stripper:dev
    environment:
      PORT: "${STRIPPER_PORT:-8080}"
    ports:
      - "${STRIPPER_HOST_PORT:-8081}:${STRIPPER_PORT:-8080}"
    healthcheck:
      test: [ "CMD", "/stripper", "-healthcheck" ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  webui:
    build:
      context: ./services/webui
      dockerfile: Dockerfile
    image: exif-webui:dev
    environment:
      PORT: "${WEBUI_PORT:-3000}"
      STRIPPER_URL: "http://stripper:${STRIPPER_PORT:-8080}/strip"
    ports:
      - "${WEBUI_PORT:-3000}:${WEBUI_PORT:-3000}"
    healthcheck:
      test: [ "CMD", "/app/webui", "-healthcheck" ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  e2e-tests:
    build:
      context: ./e2e-tests
      dockerfile: Dockerfile
    image: exif-e2e-tests:dev
    environment:
      WEBUI_URL: http://webui:${WEBUI_PORT:-3000}
    restart: "no"
    depends_on:
      stripper:
        condition: service_healthy
      webui:
        condition: service_healthy
